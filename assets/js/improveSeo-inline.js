jQuery(document).ready(function ($) {
  $("#build_post").on("click", function (event) {
    event.preventDefault();
    var projectId = $(this).data("project-id");
    build_project(projectId);
  });
  $(".update-project").on("click", function (event) {
    event.preventDefault();
    var projectId = $(this).data("id");
    update_project(projectId);
    console.log(improveSeoData.ajax_url);
  });
});

function build_project(id) {
  jQuery(".show_loading").css("display", "block");
  jQuery(".show_loading h1").html("Building project.... in progress");
  start_build(id);
}
var numm;

function start_build(ids) {
  var max_iterations = parseInt(jQuery("#max-iterations").val());
  var export_url = improveSeoData.export_url; // Accessing localized export URL

  jQuery.ajax({
    url: improveSeoData.ajax_url, // Accessing localized AJAX URL
    data: {
      action: "workdex_builder_ajax",
      page: 100,
      ajax: 1,
      id: ids,
    },
    success: function (data) {
      jQuery(".show_loading h1").html("Building project.... in progress");
      jQuery(".show_loading h2").html("Posts generated by now " + data);
      var is_preview_available = jQuery("#is_preview_available").val();
      if (max_iterations > 100) {
        if (numm == data) {
          jQuery(".show_loading").css("display", "none");
          if (is_preview_available == "yes") {
            window.location.href = export_url + ids + "&noheader=true";
          }
        } else {
          numm = data;
          setTimeout(function () {
            start_build(ids);
          }, 100);
        }
        location.reload(true);
      } else {
        if (is_preview_available == "yes") {
          jQuery(".show_loading h1").html("Exporting posts. Please wait");
          jQuery(".show_loading h2").html("");
          window.location.href = export_url + ids + "&noheader=true";
        } else {
          setTimeout(function () {
            jQuery(".show_loading").css("display", "none");
            location.reload(true);
          }, 100);
        }
      }
    },
  });
}
function update_project(id) {
  jQuery(".show_loading").css("display", "block");
  jQuery(".show_loading h1").html("Updating project.... in progress");
  start_update(id);
}
var numm_update;

function start_update(ids) {
  var mainDomain = improveSeoData.site_url;

  console.log("‚öôÔ∏è start_update() called for ID:", ids);

  var max_iterations = parseInt(jQuery("#max-iterations").val()) || 0;
  var export_url =
    mainDomain +
    "/wp-admin/admin.php?page=improveseo_projects&action=export_preview_url&id=";

  jQuery.ajax({
    url: ajax_vars.ajax_url,
    type: "GET",
    dataType: "json",
    data: {
      action: "workdex_builder_update_ajax",
      page: 100,
      ajax: 1,
      id: ids,
    },
    success: function (data) {
      console.log("‚úÖ AJAX Success:", data);

      if (!data || isNaN(data)) {
        console.error("‚ùå Invalid response from server:", data);
        return;
      }

      jQuery(".show_loading h1").html("Building project.... in progress");
      jQuery(".show_loading h2").html("Posts generated by now " + data);

      var is_preview_available = jQuery("#is_preview_available").val();

      if (max_iterations > 100) {
        if (numm == data) {
          jQuery(".show_loading").css("display", "none");
          if (is_preview_available == "yes") {
            console.log("‚úÖ Redirecting to export preview...");
            window.location.href = export_url + ids + "&noheader=true";
          }
        } else {
          numm = data;
          setTimeout(() => start_update(ids), 100);
        }
        location.reload(true);
      } else {
        console.log("üîó Export URL:", export_url + ids + "&noheader=true");

        if (is_preview_available === "yes") {
          jQuery(".show_loading h1").html("Exporting posts. Please wait...");
          jQuery(".show_loading h2").html("");
          console.log("‚úÖ Export ready. Redirecting...");
          window.location.href = export_url + ids + "&noheader=true";
        } else {
          setTimeout(() => {
            jQuery(".show_loading").css("display", "none");
            location.reload(true);
          }, 100);
        }
      }
    },
    error: function (xhr, status, error) {
      console.error("‚ùå AJAX Error:", error);
    },
  });
}

jQuery("#cb-select-all").click(function (e) {
  jQuery("input[type=checkbox]").prop("checked", jQuery(this).prop("checked"));
});
